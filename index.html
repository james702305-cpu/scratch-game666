<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è²¡ç¥çˆºåˆ®åˆ®æ¨‚-ä»¿çœŸé–å®šç‰ˆ</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@fingerprintjs/fingerprintjs@3/dist/fp.min.js"></script>
    <style>
        :root { --gold: #D4AF37; --red: #B22222; }
        body { background: #222; color: #fff; font-family: sans-serif; display: flex; flex-direction: column; align-items: center; padding: 20px; touch-action: manipulation; }
        
        .main-container { display: flex; flex-direction: row; align-items: flex-start; gap: 30px; max-width: 850px; width: 100%; justify-content: center; margin-top: 20px; }
        .scratch-card { position: relative; width: 300px; height: 400px; background: var(--gold); padding: 10px; border-radius: 15px; overflow: hidden; flex-shrink: 0; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .rules-container { background: rgba(255, 255, 255, 0.05); padding: 20px; border-radius: 15px; border-left: 5px solid var(--gold); width: 300px; }
        .prize-layer { position: absolute; inset: 10px; background: #fff; border-radius: 10px; display: flex; flex-direction: column; justify-content: center; align-items: center; color: var(--red); z-index: 1; text-align: center; }
        .prize-amount { font-size: 2.2rem; font-weight: bold; margin: 10px 0; }
        #scratch-canvas { position: absolute; top: 10px; left: 10px; z-index: 5; cursor: crosshair; touch-action: none; border-radius: 10px; transition: opacity 0.6s; }
        #claim-btn { display: none; margin-top: 30px; padding: 15px 40px; background: linear-gradient(45deg, #FFD700, #FFA500); border: none; font-weight: bold; cursor: pointer; border-radius: 50px; color: #8B0000; font-size: 18px; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        #loading-overlay { position: absolute; inset: 10px; background: #fff; z-index: 100; display: flex; align-items: center; justify-content: center; color: #333; border-radius: 10px; font-weight: bold; }
        @media (max-width: 700px) { .main-container { flex-direction: column; align-items: center; } }
    </style>
</head>
<body>

    <h2>ğŸ§§ è²¡ç¥åˆ°åˆ®åˆ®æ¨‚ ğŸ§§</h2>

    <div class="main-container">
        <div class="scratch-card">
            <div id="loading-overlay">æ­£åœ¨æ­è«‹è²¡ç¥çˆº...</div>
            <div class="prize-layer">
                <span style="font-size: 1rem; color: #666;">æ­å–œç²å¾—</span>
                <div class="prize-amount" id="display-name">---</div>
                <div style="font-size: 11px; color: #999; border: 1px dashed #ccc; padding: 5px;">é©—è­‰ç¢¼ï¼š<span id="display-code">---</span></div>
            </div>
            <canvas id="scratch-canvas" width="300" height="400"></canvas>
        </div>

        <div class="rules-container">
            <h3>ğŸ“œ éŠæˆ²è¦å‰‡èªªæ˜</h3>
            <ol>
                <li>æ¯äººé™åƒåŠ ä¹™æ¬¡ï¼Œç³»çµ±å°‡è‡ªå‹•é–å®šçé …ã€‚</li>
                <li>è«‹åˆ®é–‹è²¡ç¥çˆºé¡¯ç¤ºçé …ï¼Œåˆ®é–‹ 40% å³è‡ªå‹•é¡¯ç¤ºã€‚</li>
                <li>ä¸­çå¾Œè«‹é»æ“Šä¸‹æ–¹æŒ‰éˆ•é ˜å–ã€‚</li>
                <li>â€»è«‹ç§è¨Šè³£å®¶æ‚¨çš„è¦çš®å¸³è™Ÿèˆ‡é‡‘é¡â€»ã€‚</li>
            </ol>
        </div>
    </div>

    <button id="claim-btn">é»æˆ‘é ˜å–çé …</button>
    <p id="status-msg" style="color: gold; margin-top: 15px; font-weight: bold;">è¼‰å…¥ä¸­...</p>

    <script>
        // 1. é…ç½®
        const firebaseConfig = {
            apiKey: "AIzaSyCLAJqUYGVFRnS0randoKFhyMW4Wx0YoOw",
            databaseURL: "https://my-scratch-game-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "my-scratch-game",
        };
        const GOOGLE_FORM = "https://docs.google.com/forms/d/e/1FAIpQLSfs2Z_ASJ5sp9OlXARf5ePyll9iiLqhAC2F6mcntabK7mQNcA/viewform?usp=pp_url";
        const SECRET = "LUCKY_2025";

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const canvas = document.getElementById('scratch-canvas');
        const ctx = canvas.getContext('2d');

        const prizes = [
            { n: "500å…ƒæŠ˜åƒ¹å·", p: 0.05 },
            { n: "200å…ƒæŠ˜åƒ¹å·", p: 0.10 },
            { n: "100å…ƒæŠ˜åƒ¹å·", p: 0.30 },
            { n: "50å…ƒæŠ˜åƒ¹å·", p: 0.55 }
        ];

        function getHash(name) {
            let str = name + SECRET, hash = 0;
            for (let i = 0; i < str.length; i++) { hash = ((hash << 5) - hash) + str.charCodeAt(i); hash |= 0; }
            return Math.abs(hash).toString(36).toUpperCase();
        }

        // 2. æ ¸å¿ƒé–å®šé‚è¼¯
        async function start() {
            // A. å…ˆçœ‹æ‰‹æ©Ÿæœ‰æ²’æœ‰é–å®šç´€éŒ„ (æœ€å„ªå…ˆï¼Œé˜²æ­¢åˆ·æ–°çé …)
            const lock = localStorage.getItem('prize_lock_final');
            if (lock) {
                const data = JSON.parse(lock);
                render(data.name, data.code, true);
                return;
            }

            try {
                // B. æ²’é–å®šæ‰é€£è³‡æ–™åº«
                const fp = await FingerprintJS.load();
                const result = await fp.get();
                const vid = result.visitorId;

                db.ref('players/' + vid).once('value').then((snap) => {
                    if (snap.exists()) {
                        const data = snap.val();
                        localStorage.setItem('prize_lock_final', JSON.stringify(data));
                        render(data.name, data.code, true);
                    } else {
                        drawNew(vid);
                    }
                }).catch(() => drawNew("guest_" + Date.now()));
            } catch (e) { drawNew("guest_" + Date.now()); }
        }

        function drawNew(vid) {
            const r = Math.random();
            let sum = 0, win = prizes[3];
            for (let p of prizes) { sum += p.p; if (r <= sum) { win = p; break; } }
            const res = { name: win.n, code: getHash(win.n) };
            
            localStorage.setItem('prize_lock_final', JSON.stringify(res));
            if (!vid.includes("guest")) db.ref('players/' + vid).set({ ...res, time: Date.now() });
            render(res.name, res.code, false);
        }

        function render(name, code, isOld) {
            document.getElementById('display-name').innerText = name;
            document.getElementById('display-code').innerText = code;
            document.getElementById('loading-overlay').style.display = 'none';
            document.getElementById('status-msg').innerText = isOld ? "âš ï¸ çé …å·²å›ºå®šï¼Œæ­¡è¿ç¹¼çºŒåˆ®é–‹ï¼" : "ğŸ§§ è²¡ç¥é§•åˆ°ï¼è«‹ç”¨åŠ›åˆ®é–‹ï¼";
            initCanvas();
        }

        // 3. ä»¿çœŸç•«å¸ƒèˆ‡ç¡¬å¹£æ•ˆæœ
        function initCanvas() {
            ctx.fillStyle = '#B22222';
            ctx.fillRect(0, 0, 300, 400);
            const img = new Image();
            img.src = 'cover.jpg.png?t=' + Date.now();
            img.onload = () => ctx.drawImage(img, 0, 0, 300, 400);

            let drawing = false;
            const pos = (e) => {
                const r = canvas.getBoundingClientRect();
                const t = e.touches ? e.touches[0] : e;
                return { x: t.clientX - r.left, y: t.clientY - r.top };
            };

            const scratch = (e) => {
                if (!drawing) return;
                const { x, y } = pos(e);
                ctx.globalCompositeOperation = 'destination-out';
                
                // ä»¿çœŸç¡¬å¹£æ ¸å¿ƒï¼šå¤§åœ“
                ctx.beginPath();
                ctx.arc(x, y, 20, 0, Math.PI * 2);
                ctx.fill();

                // ä»¿çœŸç¡¬å¹£ç¢å±‘ï¼šéš¨æ©Ÿå°é»å™´æ¿º
                for(let i=0; i<8; i++) {
                    const ox = (Math.random() - 0.5) * 45;
                    const oy = (Math.random() - 0.5) * 45;
                    ctx.beginPath();
                    ctx.arc(x + ox, y + oy, Math.random() * 3, 0, Math.PI * 2);
                    ctx.fill();
                }
            };

            canvas.onmousedown = canvas.ontouchstart = (e) => { drawing = true; scratch(e); };
            window.onmouseup = window.ontouchend = () => { drawing = false; check(); };
            canvas.onmousemove = canvas.ontouchmove = scratch;
        }

        function check() {
            const data = ctx.getImageData(0, 0, 300, 400).data;
            let clear = 0;
            // è·³æ­¥æª¢æŸ¥æé«˜æ•ˆèƒ½
            for (let i = 3; i < data.length; i += 32) { if (data[i] === 0) clear++; }
            
            if (clear / (data.length / 32) > 0.4) {
                canvas.style.opacity = "0";
                setTimeout(() => {
                    canvas.style.display = "none";
                    document.getElementById('claim-btn').style.display = 'block';
                    document.getElementById('status-msg').innerText = "ğŸ‰ æ­å–œä¸­çï¼é»æ“ŠæŒ‰éˆ•é ˜å–çé …ï¼";
                }, 600);
            }
        }

        document.getElementById('claim-btn').onclick = () => {
            const n = document.getElementById('display-name').innerText;
            const c = document.getElementById('display-code').innerText;
            location.href = `${GOOGLE_FORM}&entry.1938722113=${encodeURIComponent(n)}&entry.695651720=${encodeURIComponent(c)}`;
        };

        start();
    </script>
</body>
</html>
