<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è²¡ç¥çˆºåˆ®åˆ®æ¨‚-çµ‚æ¥µç©©å¥ç‰ˆ</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@fingerprintjs/fingerprintjs@3/dist/fp.min.js"></script>
    <style>
        :root { --gold: #D4AF37; --red: #B22222; }
        body { background: #222; color: #fff; font-family: sans-serif; display: flex; flex-direction: column; align-items: center; padding: 20px; }
        .scratch-card { position: relative; width: 300px; height: 400px; background: var(--gold); padding: 10px; border-radius: 15px; overflow: hidden; }
        .prize-layer { position: absolute; inset: 10px; background: #fff; border-radius: 10px; display: flex; flex-direction: column; justify-content: center; align-items: center; color: var(--red); z-index: 1; text-align: center; }
        .prize-amount { font-size: 2rem; font-weight: bold; margin: 10px 0; }
        .verify-box { font-size: 11px; color: #999; border: 1px dashed #ccc; padding: 5px; background: #fafafa; }
        #scratch-canvas { position: absolute; top: 10px; left: 10px; z-index: 5; cursor: crosshair; touch-action: none; border-radius: 10px; }
        #claim-btn { display: none; margin-top: 20px; padding: 12px 30px; background: gold; border: none; font-weight: bold; cursor: pointer; border-radius: 5px; color: #8B0000; }
        #loading-overlay { position: absolute; inset: 10px; background: rgba(255,255,255,0.9); z-index: 100; display: flex; align-items: center; justify-content: center; color: #333; border-radius: 10px; font-weight: bold; }
    </style>
</head>
<body>

    <h2>ğŸ§§ è²¡ç¥åˆ°åˆ®åˆ®æ¨‚ ğŸ§§</h2>

    <div class="scratch-card">
        <div id="loading-overlay">è¼‰å…¥ä¸­ï¼Œè«‹ç¨å€™...</div>
        <div class="prize-layer">
            <span>æ­å–œç²å¾—</span>
            <div class="prize-amount" id="display-name">---</div>
            <div class="verify-box">é©—è­‰ä»£ç¢¼ï¼š<span id="display-code">---</span></div>
        </div>
        <canvas id="scratch-canvas" width="300" height="400"></canvas>
    </div>

    <button id="claim-btn">é»æˆ‘é ˜å–çé …</button>
    <p id="status-msg" style="color: gold; margin-top: 10px;">è«‹ç”¨åŠ›åˆ®é–‹è²¡ç¥çˆºï¼</p>

    <script>
        // 1. è¨­å®šå€
        var firebaseConfig = {
            apiKey: "AIzaSyCLAJqUYGVFRnS0randoKFhyMW4Wx0YoOw",
            databaseURL: "https://my-scratch-game-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "my-scratch-game",
        };

        var GOOGLE_FORM_URL = "https://docs.google.com/forms/d/e/1FAIpQLSfs2Z_ASJ5sp9OlXARf5ePyll9iiLqhAC2F6mcntabK7mQNcA/viewform?usp=pp_url"; 
        var ENTRY_PRIZE = "entry.1938722113"; 
        var ENTRY_CODE = "entry.695651720";
        var MY_SECRET_KEY = "LUCKY_2025";

        // åˆå§‹åŒ– Firebase (v8 èªæ³•æ›´ç©©)
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        var db = firebase.database();

        var canvas = document.getElementById('scratch-canvas');
        var ctx = canvas.getContext('2d');
        var displayName = document.getElementById('display-name');
        var displayCode = document.getElementById('display-code');
        var claimBtn = document.getElementById('claim-btn');

        var prizes = [
            { n: "500å…ƒæŠ˜åƒ¹å·", p: 0.05 },
            { n: "200å…ƒæŠ˜åƒ¹å·", p: 0.10 },
            { n: "100å…ƒæŠ˜åƒ¹å·", p: 0.30 },
            { n: "50å…ƒæŠ˜åƒ¹å·", p: 0.55 }
        ];

        function generateHash(name) {
            var str = name + MY_SECRET_KEY;
            var hash = 0;
            for (var i = 0; i < str.length; i++) {
                hash = ((hash << 5) - hash) + str.charCodeAt(i);
                hash |= 0;
            }
            return Math.abs(hash).toString(36).toUpperCase();
        }

        // 2. æ ¸å¿ƒéŠæˆ²é‚è¼¯
        async function start() {
            var vid = "guest_" + Math.floor(Math.random()*1000);
            
            try {
                // å˜—è©¦å–å¾—è¨­å‚™æŒ‡ç´‹
                const fp = await FingerprintJS.load();
                const result = await fp.get();
                vid = result.visitorId;

                // å˜—è©¦è®€å– Firebase (è¨­å®š 3 ç§’å¿…è§£é–)
                var timeout = setTimeout(showGame, 3000); 
                
                db.ref('players/' + vid).once('value').then((snapshot) => {
                    clearTimeout(timeout);
                    if (snapshot.exists()) {
                        var data = snapshot.val();
                        render(data.name, data.code, true);
                    } else {
                        showGame(vid);
                    }
                }).catch(e => {
                    console.error(e);
                    showGame(vid);
                });

            } catch (e) {
                console.warn("å‚™æ´æ¨¡å¼é–‹å•Ÿ");
                showGame(vid);
            }
        }

        function showGame(vid) {
            var r = Math.random(), sum = 0, win = prizes[3];
            for (var p of prizes) {
                sum += p.p;
                if (r <= sum) { win = p; break; }
            }
            var code = generateHash(win.n);
            
            // å¯«å…¥è³‡æ–™åº« (ä¸ç­‰å¾…)
            if(vid.indexOf('guest') === -1) {
                db.ref('players/' + vid).set({ name: win.n, code: code, time: Date.now() });
            }
            
            render(win.n, code, false);
        }

        function render(name, code, isOld) {
            displayName.innerText = name;
            displayCode.innerText = code;
            document.getElementById('loading-overlay').style.display = 'none';
            if (isOld) {
                canvas.style.display = 'none';
                claimBtn.style.display = 'block';
                document.getElementById('status-msg').innerText = "âš ï¸ æ‚¨å·²é ˜éçå›‰ï¼";
            } else {
                drawCover();
            }
        }

        function drawCover() {
            // 1. ç¹ªè£½ä¸€å€‹ä¿åº•çš„ç´…è‰²èƒŒæ™¯ï¼ˆé˜²æ­¢åœ–ç‰‡è¼‰å…¥å¤±æ•—æ™‚ä¸€ç‰‡ç©ºç™½ï¼‰
    ctx.fillStyle = '#B22222';
    ctx.fillRect(0, 0, 300, 400);

    // 2. å»ºç«‹åœ–ç‰‡ç‰©ä»¶
    var img = new Image();
    
    // 3. è¨­å®šåœ–ç‰‡ä¾†æºç‚ºä½ ä¸Šå‚³çš„æª”æ¡ˆåç¨± (å‹™å¿…ç¢ºèª GitHub ä¸Šæª”åæ˜¯ cover.jpg)
    img.src = 'cover.jpg'; 

    // 4. ç•¶åœ–ç‰‡ä¸‹è¼‰å®Œæˆå¾Œï¼Œç•«åˆ°ç•«å¸ƒä¸Š
    img.onload = function() {
        ctx.drawImage(img, 0, 0, 300, 400);
    };

    // 5. éŒ¯èª¤åµæ¸¬ï¼ˆé¸é…ï¼‰
    img.onerror = function() {
        console.error("æ‰¾ä¸åˆ° cover.jpgï¼Œè«‹ç¢ºèªæª”æ¡ˆå·²ä¸Šå‚³è‡³ GitHub");
    };
        }

        // 3. åˆ®åˆ®èˆ‡è·³è½‰é‚è¼¯ (å‚³çµ±äº‹ä»¶)
        var isDrawing = false;
        canvas.onmousedown = canvas.ontouchstart = function(e) { isDrawing = true; if(e.touches) e.preventDefault(); };
        window.onmouseup = window.ontouchend = function() { isDrawing = false; check(); };
        canvas.onmousemove = canvas.ontouchmove = function(e) {
            if (!isDrawing) return;
            var rect = canvas.getBoundingClientRect();
            var t = e.touches ? e.touches[0] : e;
            var x = t.clientX - rect.left;
            var y = t.clientY - rect.top;
            ctx.globalCompositeOperation = 'destination-out';
            ctx.beginPath();
            ctx.arc(x, y, 25, 0, Math.PI * 2);
            ctx.fill();
        };

        function check() {
            var data = ctx.getImageData(0, 0, 300, 400).data;
            var clear = 0;
            for (var i = 3; i < data.length; i += 4) { if (data[i] === 0) clear++; }
            if (clear / (data.length / 4) > 0.4) {
                canvas.style.display = "none";
                claimBtn.style.display = 'block';
            }
        }

        claimBtn.onclick = function() {
            var url = GOOGLE_FORM_URL + "&" + ENTRY_PRIZE + "=" + encodeURIComponent(displayName.innerText) + "&" + ENTRY_CODE + "=" + encodeURIComponent(displayCode.innerText);
            window.location.href = url;
        };

        start();
    </script>
</body>

</html>
